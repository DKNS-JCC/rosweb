<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administrativo - artTEC</title>
    <link rel="icon" type="image/x-icon" href="icon.ico">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/roslib@1.3.0/build/roslib.min.js"></script>
    <script src="https://unpkg.com/three@0.145.0/build/three.min.js"></script>
    <style>
        /* Estilos para men煤 m贸vil de usuario y autenticaci贸n */
        .nav-mobile-user,
        .nav-mobile-auth {
            display: none !important;
        }

        @media screen and (max-width: 768px) {

            .nav-mobile-user,
            .nav-mobile-auth {
                display: block !important;
            }

            .nav-mobile-divider {
                height: 1px;
                background: linear-gradient(90deg, transparent, #e9ecef, transparent);
                margin: 15px 20px;
            }

            .nav-mobile-user-info {
                padding: 10px 20px;
                text-align: center;
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                margin: 0 20px;
                border-radius: 8px;
                border-left: 4px solid #4129ca;
            }

            .nav-mobile-username {
                font-weight: 600;
                color: #4129ca;
                font-size: 16px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
            }

            .nav-mobile-username::before {
                content: "";
                font-size: 18px;
            }

            .nav-mobile-profile,
            .nav-mobile-logout {
                display: flex !important;
                align-items: center;
                justify-content: center;
                gap: 10px;
                background: none;
                border: none;
                width: 100%;
                text-decoration: none;
                font-size: 15px;
                font-weight: 500;
                transition: all 0.3s ease;
            }

            .nav-mobile-profile {
                color: #4129ca;
            }

            .nav-mobile-profile:hover {
                background: rgba(65, 41, 202, 0.1);
                color: #4129ca;
            }

            .nav-mobile-logout {
                color: #dc3545;
                cursor: pointer;
            }

            .nav-mobile-logout:hover {
                background: rgba(220, 53, 69, 0.1);
                color: #dc3545;
            }

            .nav-mobile-profile svg,
            .nav-mobile-logout svg {
                flex-shrink: 0;
            }

            /* Botones de autenticaci贸n en m贸vil */
            .nav-mobile-auth-buttons {
                display: flex;
                flex-direction: column;
                gap: 10px;
                padding: 0 20px;
            }

            .nav-mobile-auth-btn {
                padding: 12px 20px;
                text-align: center;
                text-decoration: none;
                border-radius: 8px;
                font-weight: 600;
                transition: all 0.3s ease;
            }

            .nav-mobile-login {
                background: transparent;
                color: #4129ca;
                border: 2px solid #4129ca;
            }

            .nav-mobile-login:hover {
                background: #4129ca;
                color: white;
            }

            .nav-mobile-register {
                background: #4129ca;
                color: white;
                border: 2px solid #4129ca;
            }

            .nav-mobile-register:hover {
                background: #3a23b8;
                border-color: #3a23b8;
            }

            /* Ocultar dropdown de usuario en m贸vil */
            .nav-user-dropdown {
                display: none;
            }

            .nav-user-info {
                display: none;
            }

            /* Ocultar botones de autenticaci贸n del header en m贸vil */
            .nav-auth-menu {
                display: none;
            }
        }

        /* Estilos para modal de tours */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: #4129ca;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #000;
        }

        .tour-form {
            padding: 25px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4129ca;
            box-shadow: 0 0 0 2px rgba(65, 41, 202, 0.1);
        }

        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .tours-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .modal-footer {
                flex-direction: column-reverse;
            }
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-active {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-inactive {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
            margin: 0 2px;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid #007bff;
            color: #007bff;
        }

        .btn-outline:hover {
            background-color: #007bff;
            color: white;
        }

        .btn-danger {
            background-color: #dc3545;
            border: 1px solid #dc3545;
            border-radius: 4px;
            padding: 6px 12px;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f5f5f5;
            font-weight: 600;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        .rating-stars {
            color: #ffc107;
            font-size: 16px;
            display: inline-flex;
            align-items: center;
            gap: 2px;
        }

        .rating-text {
            margin-left: 5px;
            font-size: 12px;
            color: #666;
        }

        .reviews-modal {
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .reviews-modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .review-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #4129ca;
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .review-user {
            font-weight: 600;
            color: #4129ca;
        }

        .review-date {
            font-size: 12px;
            color: #666;
        }

        .review-rating {
            color: #ffc107;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .review-feedback {
            color: #333;
            line-height: 1.4;
        }

        .btn-reviews {
            background-color: #17a2b8;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin: 0 2px;
        }

        .btn-reviews:hover {
            background-color: #138496;
        }

        .admin-container {
            min-width: 80%;
            margin: 0 auto;
            padding: 20px;
            background: white;
            min-height: 100vh;
        }

        .admin-header {
            background: #4129ca;
            color: rgb(255, 255, 255);
            padding: 20px;
            margin: -20px -20px 30px -20px;
            border-radius: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .admin-title h1 {
            margin: 0;
            font-size: 1.8rem;
        }

        .admin-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 4px solid gray;
        }

        .admin-section h2 {
            color: gray;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-top: 4px solid gray;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: gray;
        }

        .route-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .route-form input,
        .route-form textarea {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .route-form textarea {
            grid-column: 1 / -1;
            min-height: 100px;
            resize: vertical;
        }

        .routes-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .routes-table th,
        .routes-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .routes-table th {
            background: gray;
            color: white;
            font-weight: 600;
        }

        .routes-table tr:hover {
            background: #f8f9fa;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }

        .btn-info:hover {
            background: #138496;
        }

        .user-role {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }

        .role-admin {
            background: #dc3545;
            color: white;
        }

        .role-user {
            background: #28a745;
            color: white;
        }

        .user-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .warning-banner {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }

        .access-info {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        /* Estilos para waypoints */
        .waypoints-section {
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .waypoints-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .waypoint-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s ease;
        }

        .waypoint-item:hover {
            background: #f8f9fa;
            border-color: #4129ca;
        }

        .waypoint-number {
            background: #4129ca;
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            flex-shrink: 0;
        }

        .waypoint-coords {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 10px;
            align-items: center;
        }

        .waypoint-input {
            padding: 5px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            width: 100%;
        }

        .waypoint-input:focus {
            outline: none;
            border-color: #4129ca;
            box-shadow: 0 0 0 2px rgba(65, 41, 202, 0.1);
        }

        .waypoint-actions {
            display: flex;
            gap: 5px;
        }

        .btn-waypoint {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }

        .btn-up {
            background: #17a2b8;
            color: white;
        }

        .btn-down {
            background: #6c757d;
            color: white;
        }

        .btn-remove {
            background: #dc3545;
            color: white;
        }

        .btn-waypoint:hover {
            opacity: 0.8;
        }

        .btn-waypoint:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .waypoint-description {
            grid-column: 1 / -1;
            margin-top: 5px;
        }

        /* Estilos espec铆ficos para el modal del mapa */
        #mapModal .modal-content {
            max-width: 1200px;
            height: 90vh;
            width: 95%;
        }

        .map-container {
            display: flex;
            height: calc(100% - 120px);
        }

        .map-controls {
            width: 300px;
            padding: 20px;
            border-right: 1px solid #ddd;
            background: #f8f9fa;
            overflow-y: auto;
        }

        .connection-status {
            padding: 10px;
            border-radius: 5px;
            background: white;
            border: 1px solid #ddd;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .map-info, .robot-pose, .waypoints-preview, .tour-form-preview {
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .map-info h4, .robot-pose h4, .waypoints-preview h4, .tour-form-preview h4 {
            margin-top: 0;
            color: #4129ca;
            font-size: 14px;
            font-weight: 600;
        }

        .map-info p, .robot-pose p {
            margin: 5px 0;
            font-size: 12px;
            color: #666;
        }

        .map-canvas-container {
            flex: 1;
            position: relative;
            background: #f0f0f0;
        }

        #mapCanvas {
            width: 100%;
            height: 100%;
            cursor: crosshair;
            border: 1px solid #ddd;
        }

        .map-overlay, .map-legend {
            position: absolute;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .map-overlay {
            top: 10px;
            left: 10px;
        }

        .map-legend {
            bottom: 10px;
            right: 10px;
        }

        .map-legend > div {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .map-legend > div:last-child {
            margin-bottom: 0;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
            margin-right: 5px;
        }

        .tour-form-preview .form-group {
            margin-bottom: 10px;
        }

        .tour-form-preview label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            font-weight: 600;
            color: #333;
        }

        .tour-form-preview input, .tour-form-preview textarea {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
        }

        .tour-form-preview textarea {
            resize: vertical;
            min-height: 60px;
        }

        @media (max-width: 1200px) {
            .map-controls {
                width: 250px;
            }

            #mapModal .modal-content {
                width: 98%;
            }
        }

        @media (max-width: 900px) {
            .map-container {
                flex-direction: column;
            }

            .map-controls {
                width: 100%;
                max-height: 200px;
                border-right: none;
                border-bottom: 1px solid #ddd;
            }

            .map-canvas-container {
                min-height: 400px;
            }
        }
    </style>
</head>

<body>
    <!-- Barra de navegaci贸n fija -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <img src="icon.ico" alt="artTEC Logo" class="nav-logo-img">
                <span class="nav-logo-text">artTEC</span>
            </div>
            <ul class="nav-menu" id="navMenu">
                <li class="nav-item">
                    <a href="/" class="nav-link">Inicio</a>
                </li>
                <li class="nav-item">
                    <a href="/#tours" class="nav-link">Tours</a>
                </li>
                <li class="nav-item">
                    <a href="/#how-it-works" class="nav-link">C贸mo Funciona</a>
                </li>
                <li class="nav-item">
                    <a href="/robot" class="nav-link" id="navRobotControl">Control Robot</a>
                </li>
                <li class="nav-item">
                    <a href="/admin" class="nav-link" id="navAdmin">Administraci贸n</a>
                </li>

                <!-- Secci贸n m贸vil de usuario (solo visible en m贸vil cuando est谩 logueado) -->
                <li class="nav-item nav-mobile-user" id="navMobileUser" style="display: none;">
                    <div class="nav-mobile-divider"></div>
                    <div class="nav-mobile-user-info">
                        <div id="nav-mobile-username" class="nav-mobile-username"></div>
                    </div>
                </li>
                <li class="nav-item nav-mobile-user" id="navMobileProfile" style="display: none;">
                    <a href="/dashboard.html" class="nav-link nav-mobile-profile">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        Mi Perfil
                    </a>
                </li>
                <li class="nav-item nav-mobile-user" id="navMobileLogout" style="display: none;">
                    <button class="nav-link nav-mobile-logout" id="navMobileLogoutBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                        Cerrar Sesi贸n
                    </button>
                </li>

                <!-- Secci贸n m贸vil de autenticaci贸n (solo visible en m贸vil cuando NO est谩 logueado) -->
                <li class="nav-item nav-mobile-auth" id="navMobileAuth">
                    <div class="nav-mobile-divider"></div>
                    <div class="nav-mobile-auth-buttons">
                        <a href="/login" class="nav-mobile-auth-btn nav-mobile-login">Iniciar Sesi贸n</a>
                        <a href="/register" class="nav-mobile-auth-btn nav-mobile-register">Registrarse</a>
                    </div>
                </li>
            </ul>

            <!-- Secci贸n de usuario -->
            <div class="nav-user-section">
                <!-- Men煤 para usuarios no autenticados -->
                <div class="nav-auth-menu" id="navAuthMenu">
                    <a href="/login" class="nav-btn nav-btn-outline">Iniciar Sesi贸n</a>
                    <a href="/register" class="nav-btn nav-btn-primary">Registrarse</a>
                </div>

                <!-- Men煤 para usuarios autenticados -->
                <div class="nav-user-menu" id="navUserMenu" style="display: none;">
                    <div class="nav-user-info">
                        <span class="nav-username" id="navUsername">Usuario</span>
                    </div>
                    <div class="nav-user-dropdown">
                        <button class="nav-user-toggle" id="navUserToggle">
                            <img src="icon.ico" alt="Usuario" class="nav-user-avatar" id="navUserAvatar">
                            <svg class="nav-dropdown-arrow" width="12" height="12" viewBox="0 0 12 12">
                                <path d="M3 5L6 8L9 5" stroke="currentColor" fill="none" stroke-width="1.5" />
                            </svg>
                        </button>
                        <div class="nav-dropdown-menu" id="navDropdownMenu">
                            <a href="/dashboard.html" class="nav-dropdown-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <path
                                        d="M12 12C14.21 12 16 10.21 16 8C16 5.79 14.21 4 12 4C9.79 4 8 5.79 8 8C8 10.21 9.79 12 12 12ZM12 14C9.33 14 4 15.34 4 18V20H20V18C20 15.34 14.67 14 12 14Z"
                                        fill="currentColor" />
                                </svg>
                                Mi Perfil
                            </a>
                            <button class="nav-dropdown-item" id="navLogoutBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <path
                                        d="M17 7L15.59 8.41L18.17 11H8V13H18.17L15.59 15.59L17 17L22 12L17 7ZM4 5H12V3H4C2.9 3 2 3.9 2 5V19C2 20.1 2.9 21 4 21H12V19H4V5Z"
                                        fill="currentColor" />
                                </svg>
                                Cerrar Sesi贸n
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="nav-toggle" id="navToggle">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </nav>

    <div class="admin-container">
        <div class="admin-header">
            <div class="admin-title">
                <img src="icon.ico" alt="Logo" style="width: 40px; height: 40px;">
                <h1>Administraci贸n</h1>
            </div>
        </div>

        <!-- Estad铆sticas -->
        <div class="admin-section">
            <h2>Estad铆sticas del Sistema</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalUsers">-</div>
                    <div>Usuarios Registrados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalRoutes">-</div>
                    <div>Tours Creados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalToursCompleted">-</div>
                    <div>Tours Realizados</div>
                </div>
            </div>
        </div>

        <!-- Gesti贸n de Usuarios -->
        <div class="admin-section">
            <h2>Gesti贸n de Usuarios</h2>

            <table class="routes-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Usuario</th>
                        <th>Email</th>
                        <th>Rol</th>
                        <th>Tours Realizados</th>
                        <th>ltimo Tour</th>
                        <th>Registro</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 20px;">Cargando usuarios...</td>
                    </tr>
                </tbody>
            </table>
        </div>



        <!-- Gesti贸n de Tours/Rutas -->
        <div class="admin-section">
            <h2>Gesti贸n de Tours</h2>

            <div class="tours-controls" style="margin-bottom: 20px;">
                <button id="createTourBtn" class="btn btn-primary">Crear Nuevo Tour</button>
            </div>

            <table class="routes-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Icono</th>
                        <th>Nombre</th>
                        <th>Descripci贸n</th>
                        <th>Duraci贸n (min)</th>
                        <th>Idiomas</th>
                        <th>Waypoints</th>
                        <th>Valoraci贸n</th>
                        <th>Estado</th>
                        <th>Fecha Creaci贸n</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="toursTableBody">
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 20px;">Cargando tours...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Modal del Mapa para Crear Tours -->
        <div id="mapModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 1200px; height: 90vh;">
                <div class="modal-header">
                    <h3>Crear Tour - Seleccionar Waypoints en el Mapa</h3>
                    <span class="close" id="closeMapModal">&times;</span>
                </div>
                <div class="map-container" style="display: flex; height: calc(100% - 120px);">
                    <!-- Panel de control del mapa rotado 180 grados -->
                    <div class="map-controls" style="width: 300px; padding: 20px; border-right: 1px solid #ddd; background: #f8f9fa; overflow-y: auto;">
                        <div class="connection-status" id="mapConnectionStatus">
                            <div class="status-indicator" id="mapStatusIndicator" style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: #dc3545; margin-right: 8px;"></div>
                            <span id="mapStatusText">Conectando al robot...</span>
                        </div>
                        
                        <div class="map-info" style="margin: 20px 0; padding: 15px; background: white; border-radius: 5px; border: 1px solid #ddd;">
                            <h4 style="margin-top: 0;">Informaci贸n del Mapa</h4>
                            <div id="mapMetadata">
                                <p>Resoluci贸n: <span id="mapResolution">-</span> m/px</p>
                                <p>Tama帽o: <span id="mapSize">-</span></p>
                                <p>Origen: <span id="mapOrigin">-</span></p>
                            </div>
                        </div>

                        <div class="robot-pose" style="margin: 20px 0; padding: 15px; background: white; border-radius: 5px; border: 1px solid #ddd;">
                            <h4 style="margin-top: 0;">Posici贸n del Robot</h4>
                            <div id="robotPoseInfo">
                                <p>AMCL: <span id="amclPosition">-</span></p>
                                <p>Odometr铆a: <span id="odomPosition">-</span></p>
                            </div>
                        </div>

                        <div class="waypoints-preview" style="margin: 20px 0; padding: 15px; background: white; border-radius: 5px; border: 1px solid #ddd;">
                            <h4 style="margin-top: 0;">Waypoints del Tour</h4>
                            <p>Total: <span id="mapWaypointCount">0</span> waypoints</p>
                            <div id="mapWaypointsList" style="max-height: 200px; overflow-y: auto;">
                                <p style="color: #666; font-style: italic;">Haz clic en el mapa para a帽adir waypoints</p>
                            </div>
                            <div style="margin-top: 15px;">
                                <button type="button" id="clearMapWaypoints" class="btn btn-warning btn-small">Limpiar Waypoints</button>
                                <button type="button" id="undoLastWaypoint" class="btn btn-secondary btn-small">Deshacer ltimo</button>
                            </div>
                        </div>

                        <div class="tour-form-preview" style="margin: 20px 0; padding: 15px; background: white; border-radius: 5px; border: 1px solid #ddd;">
                            <h4 style="margin-top: 0;">Informaci贸n del Tour</h4>
                            <div class="form-group">
                                <label for="mapTourName">Nombre del Tour *</label>
                                <input type="text" id="mapTourName" placeholder="Nombre del tour" required>
                            </div>
                            <div class="form-group">
                                <label for="mapTourDescription">Descripci贸n *</label>
                                <textarea id="mapTourDescription" placeholder="Descripci贸n del tour..." required rows="3"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="mapTourDuration">Duraci贸n (min) *</label>
                                <input type="number" id="mapTourDuration" placeholder="45" min="1" required>
                            </div>
                        </div>
                    </div>

                    <!-- Canvas del mapa -->
                    <div class="map-canvas-container" style="flex: 1; position: relative; background: #f0f0f0;">
                        <canvas id="mapCanvas" style="width: 100%; height: 100%; cursor: crosshair; border: 1px solid #ddd;"></canvas>
                        <div class="map-overlay" style="position: absolute; top: 10px; left: 10px; background: rgba(255,255,255,0.9); padding: 10px; border-radius: 5px; font-size: 12px;">
                            <div>Zoom: <span id="mapZoom">1.0x</span></div>
                            <div>Coordenadas: <span id="mouseCoords">(0, 0)</span></div>
                        </div>
                        <div class="map-legend" style="position: absolute; bottom: 10px; right: 10px; background: rgba(255,255,255,0.9); padding: 10px; border-radius: 5px; font-size: 12px;">
                            <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                <div style="width: 15px; height: 15px; background: #000; margin-right: 8px;"></div>
                                <span>Obst谩culo</span>
                            </div>
                            <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                <div style="width: 15px; height: 15px; background: #fff; border: 1px solid #ccc; margin-right: 8px;"></div>
                                <span>Espacio libre</span>
                            </div>
                            <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                <div style="width: 15px; height: 15px; background: #0066cc; margin-right: 8px; border-radius: 50%;"></div>
                                <span>Robot</span>
                            </div>
                            <div style="display: flex; align-items: center;">
                                <div style="width: 15px; height: 15px; background: #ff6600; margin-right: 8px; border-radius: 50%;"></div>
                                <span>Waypoint</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelMapTour">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveMapTour">Crear Tour con Waypoints</button>
                </div>
            </div>
        </div>

        <!-- Modal para crear/editar tour -->
        <div id="tourModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="tourModalTitle">Crear Nuevo Tour</h3>
                    <span class="close" id="closeTourModal">&times;</span>
                </div>
                <form id="tourForm" class="tour-form">
                    <input type="hidden" id="tourId">

                    <div class="form-row">
                        <div class="form-group">
                            <label for="tourName">Nombre del Tour *</label>
                            <input type="text" id="tourName" placeholder="Nombre del tour" required>
                        </div>
                        <div class="form-group">
                            <label for="tourIcon">Icono</label>
                            <input type="text" id="tourIcon" placeholder="" maxlength="2">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="tourDescription">Descripci贸n *</label>
                        <textarea id="tourDescription" placeholder="Descripci贸n del tour..." required
                            rows="3"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="tourDuration">Duraci贸n (minutos) *</label>
                            <input type="number" id="tourDuration" placeholder="45" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="tourLanguages">Idiomas</label>
                            <input type="text" id="tourLanguages" placeholder="Espa帽ol, Ingl茅s, Franc茅s">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="tourStatus">Estado</label>
                        <select id="tourStatus">
                            <option value="active">Activo</option>
                            <option value="inactive">Inactivo</option>
                        </select>
                    </div>

                    <!-- Secci贸n de Waypoints -->
                    <div class="form-group" style="border-top: 2px solid #e9ecef; padding-top: 20px; margin-top: 20px;">
                        <label>Ruta de Navegaci贸n (Waypoints)</label>
                        <div class="waypoints-section">
                            <div class="waypoints-controls" style="margin-bottom: 15px;">
                                <button type="button" id="addWaypoint" class="btn btn-secondary">A帽adir Waypoint</button>
                                <button type="button" id="clearWaypoints" class="btn btn-warning">Limpiar Todo</button>
                                <span style="margin-left: 15px;">Total: <span id="waypointCount">0</span> waypoints</span>
                            </div>
                            <div class="waypoints-list" id="waypointsList" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px; background: #f8f9fa;">
                                <p id="noWaypoints" style="text-align: center; color: #666; margin: 20px 0;">No hay waypoints definidos. Haz clic en "A帽adir Waypoint" para empezar.</p>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" id="cancelTour">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="saveTour">Guardar Tour</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentUser = null;
        
        // Variables globales para el mapa
        let mapCanvas, mapCtx;
        let mapData = null;
        let robotPose = null;
        let mapWaypoints = [];
        let mapScale = 1.0;
        let mapOffset = { x: 0, y: 0 };
        let isDragging = false;
        let lastMousePos = { x: 0, y: 0 };
        
        // Variables ROS para el mapa
        let ros = null;
        let mapTopic = null;
        let amclTopic = null;
        let odomTopic = null;

        // Configurar eventos de DOM al cargar la p谩gina
        document.addEventListener('DOMContentLoaded', function () {
            setupMobileNavigation();
            setupUserDropdown();
        });

        // Verificar acceso administrativo al cargar
        window.addEventListener('load', async () => {
            await checkAdminAccess();
            await loadStats();
            await loadUsers();
            await loadTours();
            setupTourModal();
            setupMapModal();
        });

        // Configurar dropdown de usuario en navegaci贸n
        function setupUserDropdown() {
            const navUserToggle = document.getElementById('navUserToggle');
            const navDropdownMenu = document.getElementById('navDropdownMenu');

            if (navUserToggle && navDropdownMenu) {
                navUserToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    navDropdownMenu.classList.toggle('nav-dropdown-open');
                });

                // Cerrar dropdown al hacer clic fuera
                document.addEventListener('click', (event) => {
                    if (!navUserToggle.contains(event.target) && !navDropdownMenu.contains(event.target)) {
                        navDropdownMenu.classList.remove('nav-dropdown-open');
                    }
                });

                // Prevenir que el dropdown se cierre al hacer clic dentro
                navDropdownMenu.addEventListener('click', (e) => {
                    e.stopPropagation();
                });

                // Configurar logout desde navegaci贸n
                const navLogoutBtn = document.getElementById('navLogoutBtn');
                if (navLogoutBtn) {
                    navLogoutBtn.addEventListener('click', logoutUser);
                }
            }
        }

        // Funci贸n unificada de logout
        async function logoutUser() {
            try {
                const response = await fetch('/api/logout', { method: 'POST' });
                if (response.ok) {
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Error al cerrar sesi贸n:', error);
            }
        }

        // Configurar navegaci贸n m贸vil
        function setupMobileNavigation() {
            const navToggle = document.getElementById('navToggle');
            const navMenu = document.querySelector('.nav-menu');

            if (navToggle && navMenu) {
                navToggle.addEventListener('click', () => {
                    navMenu.classList.toggle('nav-menu-active');
                    navToggle.classList.toggle('toggle-active');
                });

                // Cerrar men煤 m贸vil al hacer clic en un enlace
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', () => {
                        navMenu.classList.remove('nav-menu-active');
                        navToggle.classList.remove('toggle-active');
                    });
                });

                // Configurar logout desde navegaci贸n m贸vil
                const navMobileLogoutBtn = document.getElementById('navMobileLogoutBtn');
                if (navMobileLogoutBtn) {
                    navMobileLogoutBtn.addEventListener('click', logoutUser);
                }
            }
        }

        // Mostrar estado de usuario logueado
        function updateUIForLoggedInAdmin(userData) {
            // Actualizar nombre en navegaci贸n
            const navUsername = document.getElementById('navUsername');
            const navMobileUsername = document.getElementById('nav-mobile-username');
            if (navUsername) navUsername.textContent = userData.username;
            if (navMobileUsername) navMobileUsername.textContent = userData.username;

            // Actualizar foto de perfil en navegaci贸n
            const navUserAvatar = document.getElementById('navUserAvatar');
            if (navUserAvatar) {
                navUserAvatar.src = userData.profile_picture || '/favicon.ico';
                navUserAvatar.alt = `Foto de ${userData.username}`;
            }

            // Mostrar men煤 de usuario y ocultar botones de auth
            const navUserMenu = document.getElementById('navUserMenu');
            const navAuthMenu = document.getElementById('navAuthMenu');
            const navMobileUser = document.querySelectorAll('.nav-mobile-user');
            const navMobileAuth = document.getElementById('navMobileAuth');

            if (navUserMenu) navUserMenu.style.display = 'flex';
            if (navAuthMenu) navAuthMenu.style.display = 'none';
            if (navMobileAuth) navMobileAuth.style.display = 'none';

            navMobileUser.forEach(element => {
                if (element) element.style.display = 'block';
            });
        }

        // Verificar que el usuario sea admin
        async function checkAdminAccess() {
            try {
                const response = await fetch('/api/user');
                if (response.ok) {
                    const userData = await response.json();
                    if (userData.role !== 'admin') {
                        window.location.href = '/';
                        return;
                    }
                    currentUser = userData;
                    updateUIForLoggedInAdmin(userData);
                } else {
                    window.location.href = '/login';
                }
            } catch (error) {
                window.location.href = '/login';
            }
        }

        // Cargar estad铆sticas
        async function loadStats() {
            try {
                const response = await fetch('/api/admin/stats');
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('totalUsers').textContent = stats.totalUsers;
                    document.getElementById('totalRoutes').textContent = stats.totalRoutes;
                    document.getElementById('totalToursCompleted').textContent = stats.totalToursCompleted || 0;
                }
            } catch (error) {
                console.error('Error al cargar estad铆sticas:', error);
            }
        }

        // ===== GESTIN DE USUARIOS =====

        // Cargar usuarios
        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users');
                if (response.ok) {
                    const users = await response.json();
                    displayUsers(users);
                }
            } catch (error) {
                console.error('Error al cargar usuarios:', error);
            }
        }

        // Mostrar usuarios en la tabla
        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">No hay usuarios registrados</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td><span class="user-role role-${user.role}">${user.role.toUpperCase()}</span></td>
                    <td>${user.tours_completed || 0}</td>
                    <td>${user.last_tour_date ? new Date(user.last_tour_date).toLocaleDateString() : 'Nunca'}</td>
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                    <td>
                        <div class="user-actions">
                            <button onclick="viewUserTours(${user.id}, '${user.username}')" class="btn-info" title="Ver tours">Tours</button>
                            <button onclick="changeUserRole(${user.id}, '${user.role}')" class="btn-warning" title="Cambiar rol">Rol</button>
                            <button onclick="resetUserPassword(${user.id})" class="btn-warning" title="Reset contrase帽a">Contrase帽a</button>
                            <button onclick="deleteUser(${user.id})" class="btn-danger" title="Eliminar">Eliminar</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Ver tours de un usuario
        async function viewUserTours(userId, username) {
            try {
                const response = await fetch(`/api/admin/users/${userId}/tours`);
                if (response.ok) {
                    const tours = await response.json();
                    showUserToursModal(username, tours);
                }
            } catch (error) {
                showMessage('Error al cargar tours del usuario', 'error');
            }
        }

        // Mostrar modal con tours del usuario
        function showUserToursModal(username, tours) {
            const modal = document.createElement('div');
            modal.className = 'tour-modal';
            modal.style.zIndex = '2000';

            const toursHTML = tours.length > 0 ? tours.map(tour => `
                <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0;">
                    <strong>${tour.route_icon || ''} ${tour.tour_name}</strong><br>
                    <small>Fecha: ${new Date(tour.started_at).toLocaleString()}</small><br>
                    <small>ID: ${tour.tour_id} | PIN: ${tour.pin}</small>
                </div>
            `).join('') : '<p>Este usuario no ha realizado ning煤n tour.</p>';

            modal.innerHTML = `
                <div class="tour-modal-content" style="max-width: 600px; max-height: 500px; overflow-y: auto;">
                    <h2>Tours de ${username}</h2>
                    ${toursHTML}
                    <button onclick="this.closest('.tour-modal').remove()" class="btn btn-primary">
                        Cerrar
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Cambiar rol de usuario
        async function changeUserRole(userId, currentRole) {
            const newRole = currentRole === 'admin' ? 'user' : 'admin';

            if (!confirm(`驴Cambiar el rol de este usuario a "${newRole}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/users/${userId}/role`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role: newRole })
                });

                if (response.ok) {
                    showMessage('Rol actualizado exitosamente', 'success');
                    await loadUsers();
                    await loadStats();
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'Error al cambiar rol', 'error');
                }
            } catch (error) {
                showMessage('Error de conexi贸n', 'error');
            }
        }

        // Reset contrase帽a de usuario
        async function resetUserPassword(userId) {
            const newPassword = prompt('Introduce la nueva contrase帽a (m铆nimo 6 caracteres):');

            if (!newPassword) return;

            if (newPassword.length < 6) {
                showMessage('La contrase帽a debe tener al menos 6 caracteres', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/admin/users/${userId}/password`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ newPassword })
                });

                if (response.ok) {
                    showMessage('Contrase帽a actualizada exitosamente', 'success');
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'Error al actualizar contrase帽a', 'error');
                }
            } catch (error) {
                showMessage('Error de conexi贸n', 'error');
            }
        }

        // Eliminar usuario
        async function deleteUser(userId) {
            if (!confirm('驴Est谩s seguro de que quieres eliminar este usuario? Esta acci贸n eliminar谩 tambi茅n todo su historial de tours.')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage('Usuario eliminado exitosamente', 'success');
                    await loadUsers();
                    await loadStats();
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'Error al eliminar usuario', 'error');
                }
            } catch (error) {
                showMessage('Error de conexi贸n', 'error');
            }
        }

        // Mostrar mensajes
        function showMessage(text, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `floating-message ${type}`;
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                color: white;
                font-weight: bold;
                z-index: 1000;
                animation: slideIn 0.3s ease;
                ${type === 'success' ? 'background: #28a745;' : 'background: #dc3545;'}
            `;
            messageDiv.textContent = text;

            // Add CSS animation if not exists
            if (!document.querySelector('#message-animations')) {
                const style = document.createElement('style');
                style.id = 'message-animations';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }

            document.body.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // ========== GESTIN DE TOURS ==========

        // Cargar tours desde la base de datos
        async function loadTours() {
            try {
                const response = await fetch('/api/admin/tours');
                if (response.ok) {
                    const tours = await response.json();
                    displayTours(tours);
                } else {
                    document.getElementById('toursTableBody').innerHTML =
                        '<tr><td colspan="10" style="text-align: center; color: red;">Error al cargar tours</td></tr>';
                }
            } catch (error) {
                console.error('Error loading tours:', error);
                document.getElementById('toursTableBody').innerHTML =
                    '<tr><td colspan="10" style="text-align: center; color: red;">Error de conexi贸n</td></tr>';
            }
        }

        // Mostrar tours en la tabla
        function displayTours(tours) {
            const tbody = document.getElementById('toursTableBody');

            if (!tours || tours.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" style="text-align: center;">No hay tours registrados</td></tr>';
                return;
            }

            tbody.innerHTML = tours.map(tour => `
                <tr>
                    <td>${tour.id}</td>
                    <td style="font-size: 20px; text-align: center;">${tour.icon || ''}</td>
                    <td><strong>${tour.name}</strong></td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${tour.description}</td>
                    <td>${tour.duration}</td>
                    <td>${tour.languages || 'Espa帽ol'}</td>
                    <td style="text-align: center;">
                        <span style="background: ${tour.waypoint_count > 0 ? '#28a745' : '#dc3545'}; color: white; padding: 2px 6px; border-radius: 12px; font-size: 12px;">
                             ${tour.waypoint_count || 0}
                        </span>
                    </td>
                    <td>
                        ${tour.average_rating ? `
                            <div class="rating-stars">
                                ${generateStars(tour.average_rating)}
                                <span class="rating-text">${tour.average_rating}/5 (${tour.total_ratings})</span>
                            </div>
                            <br>
                            <button onclick="showTourReviews(${tour.id}, '${tour.name}')" class="btn-reviews">Ver rese帽as</button>
                        ` : '<span style="color: #999;">Sin valoraciones</span>'}
                    </td>
                    <td>
                        <span class="status-badge ${tour.status === 'active' ? 'status-active' : 'status-inactive'}">
                            ${tour.status === 'active' ? 'Activo' : 'Inactivo'}
                        </span>
                    </td>
                    <td>${formatDate(tour.created_at)}</td>
                    <td>
                        <button onclick="editTour(${tour.id})" class="btn btn-sm btn-outline">Editar</button>
                        <button onclick="deleteTour(${tour.id}, '${tour.name}')" 
                                class="btn btn-sm btn-danger"
                                title="${tour.history_count > 0 ? 
                                    'Este tour ser谩 eliminado completamente, pero su historial de ' + tour.history_count + ' realizaci贸n(es) se mantendr谩 para estad铆sticas.' : 
                                    'Este tour ser谩 eliminado completamente.'}">
                            Eliminar
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Configurar modal de tours
        function setupTourModal() {
            const modal = document.getElementById('tourModal');
            const createBtn = document.getElementById('createTourBtn');
            const closeBtn = document.getElementById('closeTourModal');
            const cancelBtn = document.getElementById('cancelTour');
            const form = document.getElementById('tourForm');

            // Configurar eventos de waypoints
            setupWaypointsEvents();

            // Abrir modal para crear tour
            createBtn.addEventListener('click', () => {
                openMapModal();
            });

            // Cerrar modal
            [closeBtn, cancelBtn].forEach(btn => {
                btn.addEventListener('click', () => {
                    modal.style.display = 'none';
                });
            });

            // Cerrar modal al hacer clic fuera
            window.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });

            // Manejar env铆o del formulario
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveTour();
            });
        }

        // Abrir modal para crear/editar tour
        function openTourModal(tourData = null) {
            const modal = document.getElementById('tourModal');
            const title = document.getElementById('tourModalTitle');
            const form = document.getElementById('tourForm');

            if (tourData) {
                title.textContent = 'Editar Tour';
                document.getElementById('tourId').value = tourData.id;
                document.getElementById('tourName').value = tourData.name;
                document.getElementById('tourIcon').value = tourData.icon || '';
                document.getElementById('tourDescription').value = tourData.description;
                document.getElementById('tourDuration').value = tourData.duration;
                document.getElementById('tourLanguages').value = tourData.languages || '';
                document.getElementById('tourStatus').value = tourData.status;
                
                // Cargar waypoints del tour
                loadTourWaypoints(tourData.id);
            } else {
                title.textContent = 'Crear Nuevo Tour';
                form.reset();
                document.getElementById('tourId').value = '';
                document.getElementById('tourStatus').value = 'active';
                
                // Limpiar waypoints
                currentWaypoints = [];
                renderWaypoints();
            }

            modal.style.display = 'block';
        }

        // Guardar tour (crear o actualizar)
        async function saveTour() {
            const tourId = document.getElementById('tourId').value;
            const tourData = {
                name: document.getElementById('tourName').value.trim(),
                icon: document.getElementById('tourIcon').value.trim(),
                description: document.getElementById('tourDescription').value.trim(),
                duration: parseInt(document.getElementById('tourDuration').value),
                languages: document.getElementById('tourLanguages').value.trim(),
                status: document.getElementById('tourStatus').value
            };

            // Validaciones
            if (!tourData.name || !tourData.description || !tourData.duration) {
                showMessage('Por favor, completa todos los campos obligatorios', 'error');
                return;
            }

            if (tourData.duration < 1) {
                showMessage('La duraci贸n debe ser al menos 1 minuto', 'error');
                return;
            }

            try {
                const url = tourId ? `/api/admin/tours/${tourId}` : '/api/admin/tours';
                const method = tourId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(tourData)
                });

                if (response.ok) {
                    const result = await response.json();
                    const action = tourId ? 'actualizado' : 'creado';
                    const finalTourId = tourId || result.tourId;
                    
                    // Guardar waypoints si el tour se guard贸 exitosamente
                    if (currentWaypoints.length > 0) {
                        const waypointsResult = await saveWaypoints(finalTourId);
                        if (!waypointsResult.success) {
                            showMessage(`Tour ${action} pero error al guardar waypoints: ${waypointsResult.error}`, 'error');
                        } else {
                            showMessage(`Tour ${action} exitosamente con ${currentWaypoints.length} waypoints`, 'success');
                        }
                    } else {
                        // Si no hay waypoints, limpiar waypoints existentes
                        if (tourId) {
                            await saveWaypoints(finalTourId); // Esto enviar谩 un array vac铆o
                        }
                        showMessage(`Tour ${action} exitosamente`, 'success');
                    }
                    
                    document.getElementById('tourModal').style.display = 'none';
                    await loadTours();
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'Error al guardar el tour', 'error');
                }
            } catch (error) {
                console.error('Error saving tour:', error);
                showMessage('Error de conexi贸n', 'error');
            }
        }

        // Editar tour
        async function editTour(tourId) {
            try {
                const response = await fetch(`/api/admin/tours/${tourId}`);
                if (response.ok) {
                    const tour = await response.json();
                    openTourModal(tour);
                } else {
                    showMessage('Error al cargar los datos del tour', 'error');
                }
            } catch (error) {
                console.error('Error loading tour:', error);
                showMessage('Error de conexi贸n', 'error');
            }
        }

        // Eliminar tour
        async function deleteTour(tourId, tourName) {
            const confirmMessage = `驴Est谩s seguro de que quieres eliminar el tour "${tourName}"?

锔  INFORMACIN IMPORTANTE:
 La ruta ser谩 eliminada COMPLETAMENTE de la base de datos
 Se eliminar谩n todos los waypoints asociados
 El hist贸rico de tours realizados SE MANTENDR para estad铆sticas
 Los conteos de tours completados no se perder谩n

Esta acci贸n no se puede deshacer.`;

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/tours/${tourId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    const result = await response.json();
                    showMessage('Tour eliminado exitosamente', 'success');
                    
                    await loadTours();
                    await loadStats();
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'Error al eliminar el tour', 'error');
                }
            } catch (error) {
                console.error('Error deleting tour:', error);
                showMessage('Error de conexi贸n', 'error');
            }
        }

        // Funci贸n auxiliar para generar estrellas
        function generateStars(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

            let stars = '';
            for (let i = 0; i < fullStars; i++) {
                stars += '';
            }
            if (hasHalfStar) {
                stars += '';
            }
            for (let i = 0; i < emptyStars; i++) {
                stars += '';
            }
            return stars;
        }

        // Mostrar rese帽as de un tour
        async function showTourReviews(tourId, tourName) {
            try {
                const response = await fetch(`/api/admin/tours/${tourId}/reviews`);
                if (response.ok) {
                    const reviews = await response.json();
                    showReviewsModal(tourName, reviews);
                } else {
                    showMessage('Error al cargar las rese帽as', 'error');
                }
            } catch (error) {
                console.error('Error loading reviews:', error);
                showMessage('Error de conexi贸n', 'error');
            }
        }

        // Mostrar modal con rese帽as
        function showReviewsModal(tourName, reviews) {
            const modal = document.createElement('div');
            modal.className = 'reviews-modal';

            const reviewsHTML = reviews.length > 0 ? reviews.map(review => `
                <div class="review-item">
                    <div class="review-header">
                        <span class="review-user">${review.username}</span>
                        <span class="review-date">${new Date(review.started_at).toLocaleDateString('es-ES')}</span>
                    </div>
                    <div class="review-rating">
                        ${generateStars(review.rating)} (${review.rating}/5)
                    </div>
                    ${review.feedback ? `<div class="review-feedback">${review.feedback}</div>` : '<div class="review-feedback" style="font-style: italic; color: #999;">Sin comentarios</div>'}
                </div>
            `).join('') : '<p style="text-align: center; color: #999; padding: 20px;">Este tour no tiene rese帽as a煤n.</p>';

            modal.innerHTML = `
                <div class="reviews-modal-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #4129ca; padding-bottom: 10px;">
                        <h2 style="margin: 0; color: #4129ca;">Rese帽as de "${tourName}"</h2>
                        <button onclick="this.closest('.reviews-modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
                    </div>
                    <div style="max-height: 500px; overflow-y: auto;">
                        ${reviewsHTML}
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="this.closest('.reviews-modal').remove()" class="btn btn-primary">
                            Cerrar
                        </button>
                    </div>
                </div>
            `;

            // Cerrar modal al hacer clic fuera
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            document.body.appendChild(modal);
        }

        // Funci贸n auxiliar para formatear fechas
        function formatDate(dateString) {
            if (!dateString) return '-';
            return new Date(dateString).toLocaleDateString('es-ES', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ========== GESTIN DE WAYPOINTS ==========

        let currentWaypoints = [];

        // Configurar eventos de waypoints
        function setupWaypointsEvents() {
            document.getElementById('addWaypoint').addEventListener('click', addWaypoint);
            document.getElementById('clearWaypoints').addEventListener('click', clearAllWaypoints);
        }

        // Agregar nuevo waypoint
        function addWaypoint() {
            const waypoint = {
                x: 0.0,
                y: 0.0,
                z: 0.0,
                description: ''
            };
            
            currentWaypoints.push(waypoint);
            renderWaypoints();
        }

        // Eliminar waypoint
        function removeWaypoint(index) {
            if (confirm('驴Eliminar este waypoint?')) {
                currentWaypoints.splice(index, 1);
                renderWaypoints();
            }
        }

        // Mover waypoint hacia arriba
        function moveWaypointUp(index) {
            if (index > 0) {
                [currentWaypoints[index], currentWaypoints[index - 1]] = 
                [currentWaypoints[index - 1], currentWaypoints[index]];
                renderWaypoints();
            }
        }

        // Mover waypoint hacia abajo
        function moveWaypointDown(index) {
            if (index < currentWaypoints.length - 1) {
                [currentWaypoints[index], currentWaypoints[index + 1]] = 
                [currentWaypoints[index + 1], currentWaypoints[index]];
                renderWaypoints();
            }
        }

        // Limpiar todos los waypoints
        function clearAllWaypoints() {
            if (currentWaypoints.length === 0) return;
            
            if (confirm('驴Eliminar todos los waypoints?')) {
                currentWaypoints = [];
                renderWaypoints();
            }
        }

        // Renderizar lista de waypoints
        function renderWaypoints() {
            const container = document.getElementById('waypointsList');
            const countElement = document.getElementById('waypointCount');
            const noWaypointsElement = document.getElementById('noWaypoints');
            
            countElement.textContent = currentWaypoints.length;
            
            if (currentWaypoints.length === 0) {
                noWaypointsElement.style.display = 'block';
                container.innerHTML = '<p id="noWaypoints" style="text-align: center; color: #666; margin: 20px 0;">No hay waypoints definidos. Haz clic en "A帽adir Waypoint" para empezar.</p>';
                return;
            }
            
            noWaypointsElement.style.display = 'none';
            
            const waypointsHTML = currentWaypoints.map((waypoint, index) => `
                <div class="waypoint-item">
                    <div class="waypoint-number">${index + 1}</div>
                    <div class="waypoint-coords">
                        <input type="number" step="0.1" value="${waypoint.x}" 
                               class="waypoint-input" placeholder="X" 
                               onchange="updateWaypointCoord(${index}, 'x', this.value)">
                        <input type="number" step="0.1" value="${waypoint.y}" 
                               class="waypoint-input" placeholder="Y" 
                               onchange="updateWaypointCoord(${index}, 'y', this.value)">
                        <input type="number" step="0.1" value="${waypoint.z}" 
                               class="waypoint-input" placeholder="Z" 
                               onchange="updateWaypointCoord(${index}, 'z', this.value)">
                        <div class="waypoint-actions">
                            <button type="button" class="btn-waypoint btn-up" 
                                    onclick="moveWaypointUp(${index})" 
                                    ${index === 0 ? 'disabled' : ''} title="Subir"></button>
                            <button type="button" class="btn-waypoint btn-down" 
                                    onclick="moveWaypointDown(${index})" 
                                    ${index === currentWaypoints.length - 1 ? 'disabled' : ''} title="Bajar"></button>
                            <button type="button" class="btn-waypoint btn-remove" 
                                    onclick="removeWaypoint(${index})" title="Eliminar"></button>
                        </div>
                        <input type="text" value="${waypoint.description}" 
                               class="waypoint-input waypoint-description" placeholder="Descripci贸n (opcional)" 
                               onchange="updateWaypointCoord(${index}, 'description', this.value)">
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = waypointsHTML;
        }

        // Actualizar coordenada de waypoint
        function updateWaypointCoord(index, coord, value) {
            if (coord === 'description') {
                currentWaypoints[index][coord] = value;
            } else {
                currentWaypoints[index][coord] = parseFloat(value) || 0;
            }
        }

        // Cargar waypoints de un tour
        async function loadTourWaypoints(tourId) {
            if (!tourId) {
                currentWaypoints = [];
                renderWaypoints();
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/tours/${tourId}/waypoints`);
                if (response.ok) {
                    currentWaypoints = await response.json();
                    renderWaypoints();
                } else {
                    console.log('No hay waypoints para este tour o error al cargar');
                    currentWaypoints = [];
                    renderWaypoints();
                }
            } catch (error) {
                console.error('Error al cargar waypoints:', error);
                currentWaypoints = [];
                renderWaypoints();
            }
        }

        // Guardar waypoints en el servidor
        async function saveWaypoints(tourId) {
            if (!tourId) {
                console.log('No se puede guardar waypoints sin ID de tour');
                return { success: false };
            }
            
            try {
                const response = await fetch(`/api/admin/tours/${tourId}/waypoints`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ waypoints: currentWaypoints })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Waypoints guardados:', result.message);
                    return { success: true, data: result };
                } else {
                    const error = await response.json();
                    console.error('Error al guardar waypoints:', error.error);
                    return { success: false, error: error.error };
                }
            } catch (error) {
                console.error('Error de conexi贸n al guardar waypoints:', error);
                return { success: false, error: 'Error de conexi贸n' };
            }
        }

        // Abrir modal del mapa
        function openMapModal() {
            const modal = document.getElementById('mapModal');
            modal.style.display = 'block';
            
            // Inicializar canvas
            initMapCanvas();
            
            // Conectar a ROS
            initializeROS();
            
            // Limpiar formulario
            document.getElementById('mapTourName').value = '';
            document.getElementById('mapTourDescription').value = '';
            document.getElementById('mapTourDuration').value = '';
            
            // Limpiar waypoints
            mapWaypoints = [];
            updateMapWaypointsList();
        }

        // Inicializar canvas del mapa
        function initMapCanvas() {
            mapCanvas = document.getElementById('mapCanvas');
            mapCtx = mapCanvas.getContext('2d');
            
            // Ajustar tama帽o del canvas
            resizeMapCanvas();
            
            // Eventos del canvas
            mapCanvas.addEventListener('mousedown', onMapMouseDown);
            mapCanvas.addEventListener('mousemove', onMapMouseMove);
            mapCanvas.addEventListener('mouseup', onMapMouseUp);
            mapCanvas.addEventListener('click', onMapClick);
            mapCanvas.addEventListener('wheel', onMapWheel);
            
            // Redibujar el mapa
            drawMap();
        }

        // Redimensionar canvas
        function resizeMapCanvas() {
            const container = mapCanvas.parentElement;
            mapCanvas.width = container.clientWidth;
            mapCanvas.height = container.clientHeight;
            drawMap();
        }

        // Inicializar conexi贸n ROS
        function initializeROS() {
            console.log(' Conectando a ROS Bridge...');
            updateMapStatus('Conectando a ROS Bridge...', false);
            
            // Crear conexi贸n ROS
            ros = new ROSLIB.Ros({
                url: 'ws://turtlebot-NUC.local:9090'
            });

            // Eventos de conexi贸n
            ros.on('connection', function() {
                console.log(' Conectado a ROS Bridge');
                updateMapStatus('Conectado a ROS Bridge', true);
                setupMapSubscriptions();
            });

            ros.on('error', function(error) {
                console.error(' Error de ROS:', error);
                updateMapStatus('Error de conexi贸n ROS', false);
            });

            ros.on('close', function() {
                console.log(' Conexi贸n ROS cerrada');
                updateMapStatus('Conexi贸n ROS cerrada', false);
            });
        }

        // Configurar suscripciones a t贸picos
        function setupMapSubscriptions() {
            if (!ros || !ros.isConnected) {
                console.log(' ROS no conectado, reintentando en 2 segundos...');
                setTimeout(setupMapSubscriptions, 2000);
                return;
            }

            console.log(' Configurando suscripciones a t贸picos...');

            // Suscripci贸n al mapa
            mapTopic = new ROSLIB.Topic({
                ros: ros,
                name: '/map',
                messageType: 'nav_msgs/OccupancyGrid'
            });

            mapTopic.subscribe(function(message) {
                console.log('猴 Datos del mapa recibidos');
                mapData = message;
                updateMapMetadata();
                drawMap();
            });

            // Suscripci贸n a pose AMCL
            amclTopic = new ROSLIB.Topic({
                ros: ros,
                name: '/amcl_pose',
                messageType: 'geometry_msgs/PoseWithCovarianceStamped'
            });

            amclTopic.subscribe(function(message) {
                console.log(' Posici贸n AMCL recibida');
                if (!robotPose) robotPose = {};
                robotPose.amcl = message;
                updateRobotPoseInfo();
                drawMap();
            });

            // Suscripci贸n a pose EKF (fallback)
            odomTopic = new ROSLIB.Topic({
                ros: ros,
                name: '/robot_pose_ekf/odom_combined',
                messageType: 'geometry_msgs/PoseWithCovarianceStamped'
            });

            odomTopic.subscribe(function(message) {
                console.log(' Posici贸n EKF recibida');
                if (!robotPose) robotPose = {};
                robotPose.odom = message;
                updateRobotPoseInfo();
                drawMap();
            });

            console.log(' Suscripciones configuradas correctamente');
            updateMapStatus('Suscrito a t贸picos ROS', true);
        }

        // Actualizar estado de conexi贸n
        function updateMapStatus(text, connected) {
            const indicator = document.getElementById('mapStatusIndicator');
            const statusText = document.getElementById('mapStatusText');
            
            indicator.style.background = connected ? '#28a745' : '#dc3545';
            statusText.textContent = text;
        }

        // Actualizar metadatos del mapa
        function updateMapMetadata() {
            if (!mapData || !mapData.info) return;
            
            const info = mapData.info;
            document.getElementById('mapResolution').textContent = info.resolution.toFixed(3);
            document.getElementById('mapSize').textContent = `${info.width} x ${info.height}`;
            document.getElementById('mapOrigin').textContent = 
                `(${info.origin.position.x.toFixed(2)}, ${info.origin.position.y.toFixed(2)})`;
        }

        // Actualizar informaci贸n de posici贸n del robot
        function updateRobotPoseInfo() {
            if (!robotPose) return;
            
            if (robotPose.amcl && robotPose.amcl.pose) {
                const pos = robotPose.amcl.pose.pose.position;
                document.getElementById('amclPosition').textContent = 
                    `(${pos.x.toFixed(2)}, ${pos.y.toFixed(2)})`;
            }
            
            if (robotPose.odom && robotPose.odom.pose) {
                const pos = robotPose.odom.pose.pose.position;
                document.getElementById('odomPosition').textContent = 
                    `(${pos.x.toFixed(2)}, ${pos.y.toFixed(2)})`;
            }
        }

        // Eventos del rat贸n en el canvas
        function onMapMouseDown(event) {
            isDragging = true;
            const rect = mapCanvas.getBoundingClientRect();
            lastMousePos = {
                x: event.clientX - rect.left,
                y: event.clientY - rect.top
            };
        }

        function onMapMouseMove(event) {
            const rect = mapCanvas.getBoundingClientRect();
            const mouseX = event.clientX - rect.left;
            const mouseY = event.clientY - rect.top;
            
            // Actualizar coordenadas del rat贸n
            const worldCoords = canvasToWorld(mouseX, mouseY);
            document.getElementById('mouseCoords').textContent = 
                `(${worldCoords.x.toFixed(2)}, ${worldCoords.y.toFixed(2)})`;
            
            if (isDragging) {
                // Arrastrar el mapa
                const deltaX = mouseX - lastMousePos.x;
                const deltaY = mouseY - lastMousePos.y;
                
                mapOffset.x += deltaX;
                mapOffset.y += deltaY;
                
                lastMousePos = { x: mouseX, y: mouseY };
                drawMap();
            }
        }

        function onMapMouseUp(event) {
            isDragging = false;
        }

        function onMapClick(event) {
            if (isDragging) return;
            
            const rect = mapCanvas.getBoundingClientRect();
            const mouseX = event.clientX - rect.left;
            const mouseY = event.clientY - rect.top;
            
            // Convertir coordenadas del canvas a coordenadas del mundo
            const worldCoords = canvasToWorld(mouseX, mouseY);
            
            // A帽adir waypoint
            addMapWaypoint(worldCoords.x, worldCoords.y);
        }

        function onMapWheel(event) {
            event.preventDefault();
            
            const rect = mapCanvas.getBoundingClientRect();
            const mouseX = event.clientX - rect.left;
            const mouseY = event.clientY - rect.top;
            
            // Zoom hacia el punto del rat贸n
            const scaleFactor = event.deltaY > 0 ? 0.9 : 1.1;
            const newScale = Math.max(0.1, Math.min(5.0, mapScale * scaleFactor));
            
            if (newScale !== mapScale) {
                // Ajustar offset para zoom hacia el punto del rat贸n
                mapOffset.x = mouseX - (mouseX - mapOffset.x) * (newScale / mapScale);
                mapOffset.y = mouseY - (mouseY - mapOffset.y) * (newScale / mapScale);
                
                mapScale = newScale;
                document.getElementById('mapZoom').textContent = mapScale.toFixed(1) + 'x';
                drawMap();
            }
        }

        // Convertir coordenadas del canvas a coordenadas del mundo
        function canvasToWorld(canvasX, canvasY) {
            if (!mapData || !mapData.info) return { x: 0, y: 0 };
            
            const info = mapData.info;
            
            // Convertir de canvas a coordenadas del mapa (p铆xeles del mapa)
            const mapX = (canvasX - mapOffset.x) / mapScale;
            const mapY = (canvasY - mapOffset.y) / mapScale;
            
            // CORRECCIN: Invertir Y para coincidir con el sistema de coordenadas ROS
            // Ya que en drawOccupancyGrid volteamos la imagen verticalmente
            const correctedMapY = info.height - 1 - mapY;
            
            // Convertir de coordenadas del mapa a coordenadas del mundo (metros)
            const worldX = info.origin.position.x + mapX * info.resolution;
            const worldY = info.origin.position.y + correctedMapY * info.resolution;
            
            return { x: worldX, y: worldY };
        }

        // Convertir coordenadas del mundo a coordenadas del canvas
        function worldToCanvas(worldX, worldY) {
            if (!mapData || !mapData.info) return { x: 0, y: 0 };
            
            const info = mapData.info;
            
            // Convertir de coordenadas del mundo (metros) a coordenadas del mapa (p铆xeles)
            const mapX = (worldX - info.origin.position.x) / info.resolution;
            const mapY = (worldY - info.origin.position.y) / info.resolution;
            
            // CORRECCIN: Invertir Y para coincidir con el volteo que hacemos en drawOccupancyGrid
            const correctedMapY = info.height - 1 - mapY;
            
            // Convertir de coordenadas del mapa a canvas
            const canvasX = mapX * mapScale + mapOffset.x;
            const canvasY = correctedMapY * mapScale + mapOffset.y;
            
            return { x: canvasX, y: canvasY };
        }

        // Dibujar el mapa en el canvas
        function drawMap() {
            if (!mapCtx) return;
            
            // Limpiar canvas
            mapCtx.fillStyle = '#f0f0f0';
            mapCtx.fillRect(0, 0, mapCanvas.width, mapCanvas.height);
            
            if (!mapData || !mapData.data) {
                // Mostrar mensaje de carga
                mapCtx.fillStyle = '#666';
                mapCtx.font = '16px Arial';
                mapCtx.textAlign = 'center';
                mapCtx.fillText('Cargando mapa del robot...', mapCanvas.width / 2, mapCanvas.height / 2);
                return;
            }
            
            // Dibujar mapa de ocupaci贸n
            drawOccupancyGrid();
            
            // Dibujar posici贸n del robot
            drawRobotPose();
            
            // Dibujar waypoints
            drawMapWaypoints();
        }

        // Dibujar grilla de ocupaci贸n
        function drawOccupancyGrid() {
            if (!mapData || !mapData.data || !mapData.info) return;
            
            const info = mapData.info;
            const data = mapData.data;
            
            // Crear ImageData para dibujo eficiente
            const imageData = mapCtx.createImageData(info.width, info.height);
            const pixels = imageData.data;
            
            // Corregir la orientaci贸n del mapa - ROS usa coordenadas diferentes al canvas
            for (let y = 0; y < info.height; y++) {
                for (let x = 0; x < info.width; x++) {
                    // ndice original en el array de datos ROS (fila mayor)
                    const rosIndex = y * info.width + x;
                    
                    // ndice corregido para el canvas (voltear verticalmente)
                    const canvasY = info.height - 1 - y;
                    const canvasIndex = canvasY * info.width + x;
                    const pixelIndex = canvasIndex * 4;
                    
                    const value = data[rosIndex];
                    
                    if (value === -1) {
                        // Desconocido - gris
                        pixels[pixelIndex] = 128;     // R
                        pixels[pixelIndex + 1] = 128; // G
                        pixels[pixelIndex + 2] = 128; // B
                    } else if (value === 0) {
                        // Libre - blanco
                        pixels[pixelIndex] = 255;     // R
                        pixels[pixelIndex + 1] = 255; // G
                        pixels[pixelIndex + 2] = 255; // B
                    } else {
                        // Ocupado - negro
                        pixels[pixelIndex] = 0;       // R
                        pixels[pixelIndex + 1] = 0;   // G
                        pixels[pixelIndex + 2] = 0;   // B
                    }
                    pixels[pixelIndex + 3] = 255; // Alpha
                }
            }
            
            // Crear canvas temporal para escalar
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = info.width;
            tempCanvas.height = info.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.putImageData(imageData, 0, 0);
            
            // Dibujar en el canvas principal con transformaci贸n
            mapCtx.save();
            mapCtx.translate(mapOffset.x, mapOffset.y);
            mapCtx.scale(mapScale, mapScale);
            mapCtx.drawImage(tempCanvas, 0, 0);
            mapCtx.restore();
        }

        // Dibujar posici贸n del robot
        function drawRobotPose() {
            if (!robotPose || !robotPose.amcl || !robotPose.amcl.pose) return;
            
            const pose = robotPose.amcl.pose.pose;
            const canvasPos = worldToCanvas(pose.position.x, pose.position.y);
            
            mapCtx.save();
            mapCtx.fillStyle = '#0066cc';
            mapCtx.strokeStyle = '#004499';
            mapCtx.lineWidth = 2;
            
            // Dibujar robot como c铆rculo
            mapCtx.beginPath();
            mapCtx.arc(canvasPos.x, canvasPos.y, 8 * mapScale, 0, 2 * Math.PI);
            mapCtx.fill();
            mapCtx.stroke();
            
            // Dibujar orientaci贸n
            const orientation = pose.orientation;
            const yaw = Math.atan2(2 * (orientation.w * orientation.z + orientation.x * orientation.y),
                                   1 - 2 * (orientation.y * orientation.y + orientation.z * orientation.z));
            
            const arrowLength = 15 * mapScale;
            // CORRECCIN: Ajustar la direcci贸n de la flecha para coincidir con el sistema corregido
            const arrowX = canvasPos.x + Math.cos(yaw) * arrowLength;
            const arrowY = canvasPos.y + Math.sin(yaw) * arrowLength; // Cambio: removido el signo negativo
            
            mapCtx.beginPath();
            mapCtx.moveTo(canvasPos.x, canvasPos.y);
            mapCtx.lineTo(arrowX, arrowY);
            mapCtx.stroke();
            
            mapCtx.restore();
        }

        // Dibujar waypoints del mapa
        function drawMapWaypoints() {
            mapWaypoints.forEach((waypoint, index) => {
                const canvasPos = worldToCanvas(waypoint.x, waypoint.y);
                
                mapCtx.save();
                mapCtx.fillStyle = '#ff6600';
                mapCtx.strokeStyle = '#cc4400';
                mapCtx.lineWidth = 2;
                
                // Dibujar waypoint como c铆rculo
                mapCtx.beginPath();
                mapCtx.arc(canvasPos.x, canvasPos.y, 6 * mapScale, 0, 2 * Math.PI);
                mapCtx.fill();
                mapCtx.stroke();
                
                // Dibujar n煤mero
                mapCtx.fillStyle = 'white';
                mapCtx.font = `${Math.max(10, 12 * mapScale)}px Arial`;
                mapCtx.textAlign = 'center';
                mapCtx.textBaseline = 'middle';
                mapCtx.fillText(index + 1, canvasPos.x, canvasPos.y);
                
                mapCtx.restore();
                
                // Dibujar l铆nea al waypoint anterior
                if (index > 0) {
                    const prevPos = worldToCanvas(mapWaypoints[index - 1].x, mapWaypoints[index - 1].y);
                    mapCtx.save();
                    mapCtx.strokeStyle = '#ff9933';
                    mapCtx.lineWidth = 2;
                    mapCtx.setLineDash([5, 5]);
                    mapCtx.beginPath();
                    mapCtx.moveTo(prevPos.x, prevPos.y);
                    mapCtx.lineTo(canvasPos.x, canvasPos.y);
                    mapCtx.stroke();
                    mapCtx.restore();
                }
            });
        }

        // A帽adir waypoint desde el mapa
        function addMapWaypoint(x, y) {
            showWaypointInputModal(x, y);
        }

        // Mostrar modal para ingresar datos del waypoint
        function showWaypointInputModal(x, y) {
            const modal = document.createElement('div');
            modal.className = 'waypoint-input-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 3000;
            `;

            modal.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 8px; min-width: 400px; max-width: 500px;">
                    <h3 style="margin-top: 0; color: #4129ca;">Nuevo Waypoint</h3>
                    <p style="margin-bottom: 15px; color: #666;">
                        Posici贸n: (${x.toFixed(2)}, ${y.toFixed(2)})
                    </p>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">
                            Nombre del waypoint: <span style="color: red;">*</span>
                        </label>
                        <input type="text" id="waypointNameInput" 
                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" 
                               placeholder="Ej: Recepci贸n, Sala de conferencias, etc."
                               maxlength="100">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">
                            Descripci贸n/Contexto: <span style="color: red;">*</span>
                        </label>
                        <textarea id="waypointDescriptionInput" 
                                  style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; height: 80px; resize: vertical;" 
                                  placeholder="Describe qu茅 se puede encontrar en este punto, informaci贸n relevante para el tour, etc."
                                  maxlength="500"></textarea>
                        <small style="color: #666;">M谩ximo 500 caracteres</small>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="this.closest('.waypoint-input-modal').remove()" 
                                style="padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">
                            Cancelar
                        </button>
                        <button onclick="confirmAddWaypoint(${x}, ${y})" 
                                style="padding: 8px 16px; border: none; background: #4129ca; color: white; border-radius: 4px; cursor: pointer;">
                            A帽adir Waypoint
                        </button>
                    </div>
                </div>
            `;

            // Cerrar modal al hacer clic fuera
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            // Manejar Enter para confirmar y Escape para cancelar
            modal.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    confirmAddWaypoint(x, y);
                } else if (e.key === 'Escape') {
                    modal.remove();
                }
            });

            document.body.appendChild(modal);
            
            // Enfocar el primer input
            setTimeout(() => {
                document.getElementById('waypointNameInput').focus();
            }, 100);
        }

        // Confirmar y a帽adir waypoint con datos validados
        function confirmAddWaypoint(x, y) {
            const nameInput = document.getElementById('waypointNameInput');
            const descriptionInput = document.getElementById('waypointDescriptionInput');
            
            const name = nameInput.value.trim();
            const description = descriptionInput.value.trim();
            
            // Validar campos obligatorios
            if (!name) {
                nameInput.style.borderColor = '#dc3545';
                nameInput.focus();
                showMessage('El nombre del waypoint es obligatorio', 'error');
                return;
            }
            
            if (!description) {
                descriptionInput.style.borderColor = '#dc3545';
                descriptionInput.focus();
                showMessage('La descripci贸n del waypoint es obligatoria', 'error');
                return;
            }
            
            if (name.length < 3) {
                nameInput.style.borderColor = '#dc3545';
                nameInput.focus();
                showMessage('El nombre debe tener al menos 3 caracteres', 'error');
                return;
            }
            
            if (description.length < 10) {
                descriptionInput.style.borderColor = '#dc3545';
                descriptionInput.focus();
                showMessage('La descripci贸n debe tener al menos 10 caracteres', 'error');
                return;
            }
            
            // Crear waypoint con datos completos
            mapWaypoints.push({
                x: x,
                y: y,
                z: 0.0,
                name: name,
                description: description
            });
            
            // Cerrar modal
            document.querySelector('.waypoint-input-modal').remove();
            
            // Actualizar interfaz
            updateMapWaypointsList();
            drawMap();
            
            showMessage(`Waypoint "${name}" a帽adido exitosamente`, 'success');
        }

        // Actualizar lista de waypoints del mapa
        function updateMapWaypointsList() {
            const countElement = document.getElementById('mapWaypointCount');
            const listElement = document.getElementById('mapWaypointsList');
            
            countElement.textContent = mapWaypoints.length;
            
            if (mapWaypoints.length === 0) {
                listElement.innerHTML = '<p style="color: #666; font-style: italic;">Haz clic en el mapa para a帽adir waypoints</p>';
                return;
            }
            
            const waypointsHTML = mapWaypoints.map((waypoint, index) => `
                <div style="display: flex; flex-direction: column; padding: 10px; border-bottom: 1px solid #eee; background: ${index % 2 === 0 ? '#f9f9f9' : 'white'};">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px;">
                        <div style="flex: 1;">
                            <strong style="color: #4129ca;">${index + 1}. ${waypoint.name}</strong>
                            <br>
                            <small style="color: #666;">Posici贸n: (${waypoint.x.toFixed(2)}, ${waypoint.y.toFixed(2)})</small>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="editMapWaypoint(${index})" 
                                    style="background: #28a745; color: white; border: none; border-radius: 3px; padding: 3px 8px; cursor: pointer; font-size: 12px;"
                                    title="Editar waypoint">
                                锔
                            </button>
                            <button onclick="removeMapWaypoint(${index})" 
                                    style="background: #dc3545; color: white; border: none; border-radius: 3px; padding: 3px 8px; cursor: pointer; font-size: 12px;"
                                    title="Eliminar waypoint">
                                
                            </button>
                        </div>
                    </div>
                    <div style="font-size: 14px; color: #555; line-height: 1.4;">
                        ${waypoint.description}
                    </div>
                </div>
            `).join('');
            
            listElement.innerHTML = waypointsHTML;
        }

        // Remover waypoint del mapa
        function removeMapWaypoint(index) {
            if (confirm(`驴Eliminar el waypoint "${mapWaypoints[index].name}"?`)) {
                mapWaypoints.splice(index, 1);
                updateMapWaypointsList();
                drawMap();
            }
        }

        // Editar waypoint del mapa
        function editMapWaypoint(index) {
            const waypoint = mapWaypoints[index];
            
            const modal = document.createElement('div');
            modal.className = 'waypoint-input-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 3000;
            `;

            modal.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 8px; min-width: 400px; max-width: 500px;">
                    <h3 style="margin-top: 0; color: #4129ca;">Editar Waypoint</h3>
                    <p style="margin-bottom: 15px; color: #666;">
                        Posici贸n: (${waypoint.x.toFixed(2)}, ${waypoint.y.toFixed(2)})
                    </p>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">
                            Nombre del waypoint: <span style="color: red;">*</span>
                        </label>
                        <input type="text" id="editWaypointNameInput" 
                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" 
                               placeholder="Ej: Recepci贸n, Sala de conferencias, etc."
                               maxlength="100"
                               value="${waypoint.name}">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">
                            Descripci贸n/Contexto: <span style="color: red;">*</span>
                        </label>
                        <textarea id="editWaypointDescriptionInput" 
                                  style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; height: 80px; resize: vertical;" 
                                  placeholder="Describe qu茅 se puede encontrar en este punto, informaci贸n relevante para el tour, etc."
                                  maxlength="500">${waypoint.description}</textarea>
                        <small style="color: #666;">M谩ximo 500 caracteres</small>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="this.closest('.waypoint-input-modal').remove()" 
                                style="padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">
                            Cancelar
                        </button>
                        <button onclick="confirmEditWaypoint(${index})" 
                                style="padding: 8px 16px; border: none; background: #28a745; color: white; border-radius: 4px; cursor: pointer;">
                            Guardar Cambios
                        </button>
                    </div>
                </div>
            `;

            // Cerrar modal al hacer clic fuera
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            // Manejar Enter para confirmar y Escape para cancelar
            modal.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    confirmEditWaypoint(index);
                } else if (e.key === 'Escape') {
                    modal.remove();
                }
            });

            document.body.appendChild(modal);
            
            // Enfocar el primer input
            setTimeout(() => {
                document.getElementById('editWaypointNameInput').focus();
            }, 100);
        }

        // Confirmar edici贸n de waypoint
        function confirmEditWaypoint(index) {
            const nameInput = document.getElementById('editWaypointNameInput');
            const descriptionInput = document.getElementById('editWaypointDescriptionInput');
            
            const name = nameInput.value.trim();
            const description = descriptionInput.value.trim();
            
            // Validar campos obligatorios
            if (!name) {
                nameInput.style.borderColor = '#dc3545';
                nameInput.focus();
                showMessage('El nombre del waypoint es obligatorio', 'error');
                return;
            }
            
            if (!description) {
                descriptionInput.style.borderColor = '#dc3545';
                descriptionInput.focus();
                showMessage('La descripci贸n del waypoint es obligatoria', 'error');
                return;
            }
            
            if (name.length < 3) {
                nameInput.style.borderColor = '#dc3545';
                nameInput.focus();
                showMessage('El nombre debe tener al menos 3 caracteres', 'error');
                return;
            }
            
            if (description.length < 10) {
                descriptionInput.style.borderColor = '#dc3545';
                descriptionInput.focus();
                showMessage('La descripci贸n debe tener al menos 10 caracteres', 'error');
                return;
            }
            
            // Actualizar waypoint
            mapWaypoints[index].name = name;
            mapWaypoints[index].description = description;
            
            // Cerrar modal
            document.querySelector('.waypoint-input-modal').remove();
            
            // Actualizar interfaz
            updateMapWaypointsList();
            drawMap();
            
            showMessage(`Waypoint "${name}" actualizado exitosamente`, 'success');
        }

        // Limpiar todos los waypoints del mapa
        function clearMapWaypoints() {
            mapWaypoints = [];
            updateMapWaypointsList();
            drawMap();
        }

        // Deshacer 煤ltimo waypoint
        function undoLastMapWaypoint() {
            if (mapWaypoints.length > 0) {
                mapWaypoints.pop();
                updateMapWaypointsList();
                drawMap();
            }
        }

        // Guardar tour con waypoints del mapa
        async function saveMapTour() {
            const name = document.getElementById('mapTourName').value.trim();
            const description = document.getElementById('mapTourDescription').value.trim();
            const duration = parseInt(document.getElementById('mapTourDuration').value);

            // Validar formulario
            if (!name || !description || !duration || duration < 1) {
                showMessage('Por favor, completa todos los campos del tour', 'error');
                return;
            }

            if (mapWaypoints.length === 0) {
                showMessage('A帽ade al menos un waypoint al tour', 'error');
                return;
            }

            try {
                // Crear el tour
                const tourData = {
                    name: name,
                    description: description,
                    duration: duration,
                    icon: '猴',
                    languages: 'Espa帽ol',
                    status: 'active'
                };

                const response = await fetch('/api/admin/tours', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(tourData)
                });

                const result = await response.json();

                if (result.success) {
                    // Convertir waypoints del mapa al formato requerido por el backend
                    const waypoints = mapWaypoints.map(waypoint => ({
                        x: waypoint.x,
                        y: waypoint.y,
                        z: waypoint.z,
                        description: `${waypoint.name}: ${waypoint.description}`
                    }));

                    // A帽adir waypoints al tour
                    const waypointsResponse = await fetch(`/api/admin/tours/${result.tourId}/waypoints`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ waypoints: waypoints })
                    });

                    const waypointsResult = await waypointsResponse.json();

                    if (waypointsResult.success) {
                        showMessage(`Tour "${name}" creado exitosamente con ${waypoints.length} waypoints`, 'success');
                        
                        // Cerrar modal y limpiar datos
                        document.getElementById('mapModal').style.display = 'none';
                        if (ros && ros.isConnected) {
                            ros.close();
                        }
                        
                        // Limpiar waypoints del mapa
                        mapWaypoints = [];
                        updateMapWaypointsList();
                        drawMap();
                        
                        // Actualizar tabla de tours
                        loadTours();
                    } else {
                        showMessage('Tour creado pero error al guardar waypoints: ' + waypointsResult.error, 'error');
                    }
                } else {
                    showMessage('Error al crear tour: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('Error de conexi贸n al crear tour', 'error');
            }
        }

        // Configurar eventos del modal del mapa
        function setupMapModal() {
            const modal = document.getElementById('mapModal');
            const closeBtn = document.getElementById('closeMapModal');
            const cancelBtn = document.getElementById('cancelMapTour');
            const saveBtn = document.getElementById('saveMapTour');
            const clearBtn = document.getElementById('clearMapWaypoints');
            const undoBtn = document.getElementById('undoLastWaypoint');

            // Cerrar modal
            [closeBtn, cancelBtn].forEach(btn => {
                btn.addEventListener('click', () => {
                    modal.style.display = 'none';
                    if (ros && ros.isConnected) {
                        ros.close();
                    }
                });
            });

            // Limpiar waypoints
            clearBtn.addEventListener('click', clearMapWaypoints);
            
            // Deshacer 煤ltimo waypoint
            undoBtn.addEventListener('click', undoLastMapWaypoint);

            // Guardar tour
            saveBtn.addEventListener('click', saveMapTour);

            // Cerrar modal al hacer clic fuera
            window.addEventListener('click', (event) => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                    if (ros && ros.isConnected) {
                        ros.close();
                    }
                }
            });

            // Redimensionar canvas cuando cambie el tama帽o de ventana
            window.addEventListener('resize', () => {
                if (modal.style.display === 'block') {
                    setTimeout(resizeMapCanvas, 100);
                }
            });
        }
    </script>
</body>

</html>